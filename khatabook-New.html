<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khata Book</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2E7D32; /* Deep Green */
            --secondary-color: #66BB6A; /* Lighter Green */
            --accent-color: #81C784; /* Even lighter green */
            --text-color: #333333;
            --bg-color: #F0F2F5;
            --card-bg: #FFFFFF;
            --due-color: #E53935; /* Brighter Red */
            --paid-color: #1976D2; /* Stronger Blue */
            --light-grey: #e0e0e0;
            --shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Reduced shadow */
            --border-radius: 12px; /* Reduced border-radius */
        }
        
        /* Dark Theme Styles */
        body.dark-theme {
            --primary-color: #121212;
            --secondary-color: #424242;
            --accent-color: #383838;
            --text-color: #E0E0E0;
            --bg-color: #121212;
            --card-bg: #1E1E1E;
            --light-grey: #333333;
            --shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: pan-y;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        #app-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--bg-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        
        /* Fullscreen-specific styles */
        #app-container:fullscreen {
            max-width: none;
            width: 100%;
            height: 100vh;
            overflow-y: auto; /* Enable scrolling for fullscreen content */
            margin: 0;
            box-shadow: none;
        }

        .screen {
            display: none;
            flex-direction: column;
            flex-grow: 1;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 1.25rem; /* Reduced padding */
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.15rem; /* Reduced font size */
            font-weight: 700;
            box-shadow: var(--shadow);
            z-index: 10;
            transition: background-color 0.3s ease;
        }

        .header .left-group {
            display: flex;
            align-items: center;
            gap: 1rem; /* Reduced gap */
        }

        .header .right-group {
            display: flex;
            align-items: center;
            gap: 1rem; /* Reduced gap */
        }
        
        /* Header menu for home screen */
        .home-menu-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 1.25rem; /* Reduced padding */
            font-size: 1.15rem; /* Reduced font size */
            font-weight: 700;
            box-shadow: var(--shadow);
            z-index: 10;
            transition: background-color 0.3s ease;
            gap: 0.5rem 1rem; /* Reduced gap */
            position: relative;
        }
        
        .home-menu-header .icon-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.4rem; /* Reduced font size */
            cursor: pointer;
            transition: transform 0.2s ease, color 0.2s ease;
            padding: 0;
            line-height: 1;
            position: relative;
        }
        
        .home-menu-header .icon-btn:hover {
            color: var(--light-grey);
        }

        .home-menu-header .icon-btn:active {
            transform: scale(0.9);
        }
        
        /* Dropdown menu for database icon */
        .database-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: none;
            flex-direction: column;
            min-width: 150px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .database-dropdown.show {
            display: flex;
        }

        .database-dropdown button {
            background: none;
            border: none;
            padding: 0.75rem 1rem; /* Adjusted padding */
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s;
            color: var(--text-color);
            font-size: 1rem;
        }
        
        .database-dropdown button:hover {
            background-color: var(--light-grey);
        }

        .btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem 1.25rem; /* Reduced padding */
            font-size: 0.95rem; /* Reduced font size */
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }
        
        .btn:hover {
            background-color: var(--accent-color);
        }
        
        .btn:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .icon-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.4rem; /* Reduced font size */
            cursor: pointer;
            transition: transform 0.2s ease, color 0.2s ease;
        }

        .icon-btn:hover {
            color: var(--light-grey);
        }

        .icon-btn:active {
            transform: scale(0.9);
        }

        .search-bar {
            padding: 1rem; /* Reduced padding */
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--light-grey);
            box-shadow: var(--shadow);
        }
        
        .search-bar input {
            width: 100%;
            padding: 0.75rem; /* Reduced padding */
            border: 1px solid var(--light-grey);
            border-radius: var(--border-radius);
            font-size: 0.95rem; /* Reduced font size */
            transition: border-color 0.3s ease, background-color 0.3s ease;
            background-color: inherit;
            color: inherit;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }
        
        .search-bar input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2); /* Reduced shadow */
        }
        
        form {
            padding: 1.5rem; /* Reduced padding */
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Reduced gap */
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            margin: 1rem; /* Reduced margin */
            box-shadow: var(--shadow);
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 0.95rem; /* Reduced font size */
            font-weight: bold;
            margin-bottom: 0.5rem; /* Reduced margin */
        }
        
        .form-group input, .form-group select {
            padding: 0.75rem; /* Reduced padding */
            border: 1px solid var(--light-grey);
            border-radius: 8px; /* Reduced border-radius */
            font-size: 0.95rem; /* Reduced font size */
            transition: border-color 0.3s ease;
            background-color: inherit;
            color: inherit;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .no-customers {
            text-align: center;
            padding: 2rem; /* Reduced padding */
            color: #999;
            font-style: italic;
        }
        
        body.dark-theme .no-customers {
            color: #666;
        }

        .customer-list-container {
            flex-grow: 1;
            padding: 1rem; /* Reduced padding */
            overflow-y: auto;
            background-color: var(--bg-color);
        }

        .customer-list-table-header {
            display: flex;
            font-weight: bold;
            background-color: var(--accent-color);
            color: white;
            padding: 0.75rem; /* Reduced padding */
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            font-size: 0.9rem; /* Reduced font size */
        }
        
        .customer-list-table-header > div {
            flex: 1;
            text-align: left;
        }
        
        .customer-list-table-header .customer-balance-header {
            text-align: right;
        }

        .customer-card-wrapper {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--light-grey);
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
        }
        
        .customer-card-wrapper:last-child {
            border-bottom: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        .customer-card-info {
            flex-grow: 1;
            display: flex;
            padding: 0.8rem; /* Reduced padding */
            cursor: pointer;
            font-size: 0.95rem; /* Reduced font size */
        }

        .customer-card-info:hover {
            background-color: var(--light-grey);
        }

        .customer-card-info > div {
            flex: 1;
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .customer-card-info .customer-name {
            font-weight: bold;
        }

        .customer-card-info .customer-balance {
            text-align: right;
            justify-content: flex-end;
            font-weight: bold;
        }
        
        .balance.due {
            color: var(--due-color);
        }

        .balance.paid {
            color: var(--paid-color);
        }

        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem; /* Reduced font size */
            background-color: var(--card-bg);
        }

        .transaction-table th, .transaction-table td {
            padding: 0.75rem 0.5rem; /* Reduced padding */
            text-align: left;
            border-bottom: 1px solid var(--light-grey);
        }
        
        .transaction-table th:first-child, .transaction-table td:first-child {
            padding-left: 1rem;
        }
        
        .transaction-table th:last-child, .transaction-table td:last-child {
            padding-right: 1rem;
        }

        .transaction-table th {
            background-color: var(--accent-color);
            color: white;
            font-weight: bold;
        }
        
        body.dark-theme .transaction-table th {
            background-color: var(--secondary-color);
        }

        .transaction-table .status-cell {
            font-weight: bold;
        }

        .transaction-table .status-cell.PAID {
            color: var(--paid-color);
        }

        .transaction-table .status-cell.DUE {
            color: var(--due-color);
        }

        .action-cell {
            text-align: right;
            position: relative;
        }

        .action-menu-btn {
            background: none;
            border: none;
            font-size: 1.4rem; /* Reduced font size */
            cursor: pointer;
            color: #666;
            padding: 0 0.8rem; /* Reduced padding */
            transition: color 0.2s ease;
        }
        
        body.dark-theme .action-menu-btn {
            color: #999;
        }

        .action-menu-btn:hover {
            color: var(--primary-color);
        }

        .action-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--card-bg);
            border: 1px solid var(--light-grey);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 50;
            display: flex;
            flex-direction: column;
            min-width: 120px; /* Reduced min-width */
            overflow: hidden;
        }

        .action-menu button {
            background: none;
            border: none;
            padding: 0.6rem 0.8rem; /* Reduced padding */
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s;
            color: var(--text-color);
            font-size: 0.9rem; /* Reduced font size */
        }
        
        .action-menu button:hover {
            background-color: var(--light-grey);
        }

        .action-menu.left {
            right: auto;
            left: 0;
        }

        #history-screen .content-container {
            flex-grow: 1;
            padding: 1rem 0; /* Reduced padding */
            background-color: var(--bg-color);
        }
        
        /* ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ï‡•á ‡§π‡•á‡§°‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤ */
        #history-screen .header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding-bottom: 0.5rem;
            box-shadow: var(--shadow);
        }

        #history-screen .header .header-row {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #history-screen .header .filter-row {
            display: flex;
            width: 100%;
            justify-content: flex-start;
            align-items: center;
            gap: 0.75rem; /* Reduced gap */
            margin-top: 0.75rem; /* Reduced margin */
            flex-wrap: wrap; 
            padding: 0 1.25rem 0.75rem; /* Reduced padding */
        }
        
        #history-screen .header .filter-row label {
            white-space: nowrap; 
            color: white;
            font-size: 0.9rem; /* Reduced font size */
            font-weight: 700;
        }

        #history-screen .header .filter-row input[type="date"] {
            padding: 0.5rem; /* Reduced padding */
            border: none;
            border-radius: 6px; /* Reduced border-radius */
            background-color: var(--accent-color);
            color: white;
            font-family: inherit;
            font-size: 0.85rem; /* Reduced font size */
            flex-grow: 1;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        
        #history-screen .header .filter-row input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        #history-screen .header .filter-row .btn {
            padding: 0.5rem 1rem; /* Reduced padding */
            font-size: 0.85rem; /* Reduced font size */
        }
        
        /* ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§° ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤ */
        #history-screen .monthly-summary-container {
            margin: 0 1rem 1rem; /* Reduced margin */
            background-color: var(--card-bg);
            padding: 1rem; /* Reduced padding */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        #history-screen .monthly-summary-container .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0; /* Reduced padding */
            font-size: 0.95rem; /* Reduced font size */
        }
        
        .overall-summary-list {
            flex-grow: 1;
            padding: 1rem; /* Reduced padding */
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Reduced gap */
            background-color: var(--bg-color);
        }

        .overall-summary-card {
            background-color: var(--card-bg);
            padding: 1rem; /* Reduced padding */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s ease;
            font-size: 0.95rem; /* Reduced font size */
        }
        
        .overall-summary-card:hover {
            transform: translateY(-3px); /* Reduced transform */
        }

        .overall-total {
            text-align: center;
            padding: 1rem; /* Reduced padding */
            font-size: 1.25rem; /* Reduced font size */
            font-weight: bold;
            background-color: var(--secondary-color);
            color: white;
            margin: 1rem; /* Reduced margin */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .json-viewer-container {
            flex-grow: 1;
            padding: 1rem; /* Reduced padding */
            overflow-y: auto;
            background-color: #2b2b2b;
            color: #f8f8f2;
        }
        
        .json-viewer-container pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem; /* Reduced font size */
            line-height: 1.5;
        }
        
        /* Settings Screen Specific Styles */
        #settings-screen .form-group {
            gap: 0.5rem; /* Reduced gap */
        }
        
        .theme-options {
            display: flex;
            justify-content: space-around;
            gap: 1rem; /* Reduced gap */
        }
        
        .theme-option {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* Reduced gap */
            cursor: pointer;
            padding: 0.8rem 1rem; /* Reduced padding */
            border-radius: 8px; /* Reduced border-radius */
            border: 1px solid var(--light-grey);
            transition: background-color 0.3s ease;
            flex-grow: 1;
        }
        
        .theme-option:hover {
            background-color: var(--light-grey);
        }
        
        input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 1.15rem; /* Reduced size */
            height: 1.15rem; /* Reduced size */
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            position: relative;
            cursor: pointer;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        input[type="radio"]:checked::after {
            content: '';
            width: 0.65rem; /* Reduced size */
            height: 0.65rem; /* Reduced size */
            background-color: var(--primary-color);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
        }

        #message-box {
            position: fixed;
            bottom: 1.5rem; /* Reduced bottom position */
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1rem; /* Reduced padding */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            text-align: center;
            min-width: 200px; /* Reduced min-width */
            font-size: 0.9rem;
        }

        #message-box.show {
            opacity: 1;
            visibility: visible;
        }

        #message-box.error {
            background-color: var(--due-color);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 2rem; /* Reduced padding */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            max-width: 400px; /* Reduced max-width */
            width: 90%;
            text-align: center;
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .modal-content p {
            margin-bottom: 1.5rem; /* Reduced margin */
            font-size: 1.05rem; /* Reduced font size */
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem; /* Reduced gap */
        }

        .modal-buttons .btn {
            padding: 0.7rem 1.5rem; /* Reduced padding */
            font-size: 0.9rem;
        }

        .modal-buttons .cancel-btn {
            background-color: #999;
        }

        /* Error Popup Specific Styles */
        #error-modal .modal-content {
            border-top: 5px solid var(--due-color);
            padding-top: 1.5rem;
        }
        
        #error-modal .modal-content h3 {
            color: var(--due-color);
            margin-bottom: 0.5rem;
        }
        
        #error-details {
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.85rem;
            color: var(--text-color);
            margin-bottom: 1rem;
        }

        body.dark-theme #error-details {
            background-color: #2b2b2b;
            border-color: #444;
            color: #f8f8f2;
        }

        @media (max-width: 600px) {
            .header {
                font-size: 1.05rem;
                padding: 0.8rem 1rem;
            }
            .overall-total {
                margin: 0;
                border-radius: 0;
                font-size: 1.15rem;
            }
            form {
                margin: 0.8rem;
                padding: 1.2rem;
            }
            .customer-list-container {
                padding: 0.8rem;
            }
            .customer-list-table-header {
                padding: 0.7rem;
                font-size: 0.85rem;
            }
            .customer-card-info {
                padding: 0.7rem;
                font-size: 0.9rem;
            }
            .search-bar {
                padding: 0.8rem;
            }
            .search-bar input {
                padding: 0.6rem;
            }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- Home Screen -->
        <div id="home-screen" class="screen">
            <!-- Updated Header for Home Screen -->
            <div class="home-menu-header">
                <span class="icon-btn" id="database-menu-btn">üóÉÔ∏è
                    <div class="database-dropdown" id="database-dropdown">
                        <button id="import-btn">‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç</button>
                        <button id="export-btn">‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç</button>
                    </div>
                </span>
                <span class="icon-btn" id="overallSummaryBtn">üìä</span>
                <span class="icon-btn" id="add-customer-btn">+</span>
                <span class="icon-btn" id="show-json-btn">&lt;/&gt;</span>
                <span class="icon-btn" id="fullscreen-btn">‚õ∂</span>
                <span class="icon-btn" id="settings-btn">‚öôÔ∏è</span>
            </div>
            
            <div class="search-bar">
                <input type="text" id="customer-search" placeholder="‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ñ‡•ã‡§ú‡•á‡§Ç...">
            </div>

            <!-- ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡•Ç‡§ö‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§Ø‡§æ ‡§ü‡•á‡§¨‡§≤ ‡§ú‡•à‡§∏‡§æ ‡§≤‡•á‡§Ü‡§â‡§ü -->
            <div class="customer-list-container">
                <div class="customer-list-table-header">
                    <div>‡§®‡§æ‡§Æ</div>
                    <div>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞</div>
                    <div class="customer-balance-header">‡§¨‡•à‡§≤‡•á‡§Ç‡§∏</div>
                    <div></div>
                </div>
                <div id="customer-card-list"></div>
            </div>
            <p id="no-customers" class="no-customers">‡§ï‡•ã‡§à ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è '+' ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</p>
            <input type="file" id="file-input" style="display:none;" accept=".json">
        </div>

        <!-- Add/Edit Customer Screen -->
        <div id="add-customer-screen" class="screen">
            <div class="header">
                <div class="left-group">
                    <span class="icon-btn" id="add-customer-back-btn">‚Üê</span>
                </div>
                <span id="add-customer-title">‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</span>
                <div class="right-group">
                    <span class="icon-btn" id="fullscreen-btn-add">‚õ∂</span>
                </div>
            </div>
            <form id="customer-form">
                <input type="hidden" id="customer-id">
                <div class="form-group">
                    <label for="customer-name">‡§®‡§æ‡§Æ</label>
                    <input type="text" id="customer-name" required>
                </div>
                <div class="form-group">
                    <label for="customer-mobile">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
                    <input type="text" id="customer-mobile">
                </div>
                <div class="form-group">
                    <label for="customer-type">‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</label>
                    <select id="customer-type" required>
                        <option value="Khata">‡§ñ‡§æ‡§§‡§æ</option>
                        <option value="Non-Khata">‡§®‡•â‡§®-‡§ñ‡§æ‡§§‡§æ</option>
                    </select>
                </div>
                <button type="submit" class="btn">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
            </form>
        </div>

        <!-- Daily Entry Screen -->
        <div id="daily-entry-screen" class="screen">
            <div class="header">
                <div class="left-group">
                    <span class="icon-btn" id="daily-entry-back-btn">‚Üê</span>
                </div>
                <span>‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø</span>
                <div class="right-group">
                    <span class="icon-btn" id="fullscreen-btn-entry">‚õ∂</span>
                </div>
            </div>
            <form id="daily-entry-form">
                <input type="hidden" id="entry-id">
                <input type="hidden" id="entry-customer-id">
                <div class="form-group">
                    <label for="entry-date">‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
                    <input type="date" id="entry-date" required>
                </div>
                <div class="form-group">
                    <label for="entry-detail">‡§µ‡§ø‡§µ‡§∞‡§£ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
                    <input type="text" id="entry-detail">
                </div>
                <div class="form-group">
                    <label for="entry-amount">‡§∞‡§æ‡§∂‡§ø</label>
                    <input type="number" id="entry-amount" required>
                </div>
                <div class="form-group">
                    <label for="entry-status">‡§∏‡•ç‡§•‡§ø‡§§‡§ø</label>
                    <select id="entry-status" required>
                        <option value="DUE">‡§¶‡•á‡§Ø (Due)</option>
                        <option value="PAID">‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ (Paid)</option>
                    </select>
                </div>
                <button type="submit" class="btn">‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
            </form>
        </div>
        
        <!-- History Screen -->
        <div id="history-screen" class="screen">
            <div class="header">
                <div class="header-row">
                    <span class="icon-btn" id="history-back-btn">‚Üê</span>
                    <span id="history-customer-name"></span>
                    <span class="icon-btn" id="fullscreen-btn-history">‚õ∂</span>
                    <span class="icon-btn" id="addTransactionTopBtn">+</span>
                    <button id="shareReportBtn" class="btn">‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
                </div>
                <div class="filter-row">
                    <label for="from-date">From:</label>
                    <input type="date" id="from-date">
                    <label for="to-date">To:</label>
                    <input type="date" id="to-date">
                    <button id="filter-ok-btn" class="btn">OK</button>
                </div>
            </div>
            <div class="content-container">
                <div id="monthly-summary-container" class="monthly-summary-container">
                    <div class="summary-item">
                        <span>‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø:</span>
                        <span id="summary-due-amount" class="balance due">‚Çπ0.00</span>
                    </div>
                    <div class="summary-item">
                        <span>‡§ï‡•Å‡§≤ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®:</span>
                        <span id="summary-paid-amount" class="balance paid">‚Çπ0.00</span>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="transaction-table">
                        <thead>
                            <tr>
                                <th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
                                <th>‡§µ‡§ø‡§µ‡§∞‡§£</th>
                                <th>‡§∞‡§æ‡§∂‡§ø</th>
                                <th>‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Overall Summary Screen -->
        <div id="overall-summary-screen" class="screen">
            <div class="header">
                <div class="left-group">
                    <span class="icon-btn" id="overall-summary-back-btn">‚Üê</span>
                </div>
                <span>‡§ï‡•Å‡§≤ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</span>
                <div class="right-group">
                    <span class="icon-btn" id="fullscreen-btn-summary">‚õ∂</span>
                </div>
            </div>
            <div class="overall-total">
                ‡§ï‡•Å‡§≤ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø: <span id="overall-due-amount">‚Çπ0.00</span>
            </div>
            <div id="overall-summary-list" class="overall-summary-list"></div>
        </div>
        
        <!-- JSON Viewer Screen -->
        <div id="json-viewer-screen" class="screen">
            <div class="header">
                <div class="left-group">
                    <span class="icon-btn" id="json-viewer-back-btn">‚Üê</span>
                </div>
                <span>JSON ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏</span>
                <div class="right-group">
                    <span class="icon-btn" id="fullscreen-btn-json">‚õ∂</span>
                </div>
            </div>
            <div class="json-viewer-container">
                <pre id="json-output"></pre>
            </div>
        </div>
        
        <!-- Settings Screen -->
        <div id="settings-screen" class="screen">
            <div class="header">
                <div class="left-group">
                    <span class="icon-btn" id="settings-back-btn">‚Üê</span>
                </div>
                <span>‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏</span>
                <div class="right-group">
                    <span class="icon-btn" id="fullscreen-btn-settings">‚õ∂</span>
                </div>
            </div>
            <form id="settings-form">
                <div class="form-group">
                    <label>‡§•‡•Ä‡§Æ</label>
                    <div class="theme-options">
                        <label class="theme-option">
                            <input type="radio" name="theme" value="light" checked>
                            <span>‡§≤‡§æ‡§á‡§ü</span>
                        </label>
                        <label class="theme-option">
                            <input type="radio" name="theme" value="dark">
                            <span>‡§°‡§æ‡§∞‡•ç‡§ï</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="upi-id">UPI ID</label>
                    <input type="text" id="upi-id" placeholder="‡§Ö‡§™‡§®‡•Ä UPI ID ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç">
                </div>
                <div class="form-group">
                    <label for="user-name">‡§®‡§æ‡§Æ</label>
                    <input type="text" id="user-name" placeholder="‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç">
                </div>
                <button type="submit" class="btn">‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
            </form>
        </div>
    </div>

    <!-- Floating Message Box -->
    <div id="message-box"></div>

    <!-- Custom Modals -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-content">
            <p id="delete-modal-message">‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏ ‡§Ü‡§á‡§ü‡§Æ ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?</p>
            <div class="modal-buttons">
                <button id="delete-confirm-btn" class="btn">‡§π‡§æ‡§Å</button>
                <button id="delete-cancel-btn" class="btn cancel-btn">‡§®‡§π‡•Ä‡§Ç</button>
            </div>
        </div>
    </div>

    <div id="import-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <p>‡§Ø‡§π ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§¶‡•á‡§ó‡•Ä ‡§î‡§∞ ‡§á‡§∏‡•á ‡§Ü‡§Ø‡§æ‡§§‡§ø‡§§ ‡§°‡•á‡§ü‡§æ ‡§∏‡•á ‡§¨‡§¶‡§≤ ‡§¶‡•á‡§ó‡•Ä‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?</p>
            <div class="modal-buttons">
                <button id="import-confirm-btn" class="btn">‡§π‡§æ‡§Å, ‡§°‡•á‡§ü‡§æ ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç</button>
                <button id="import-cancel-btn" class="btn cancel-btn">‡§®‡§π‡•Ä‡§Ç, ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
        </div>
    </div>

    <!-- Error Popup -->
    <div id="error-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>‡§ì‡§π! ‡§ï‡•Å‡§õ ‡§ó‡§≤‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§</h3>
            <p>‡§ï‡•É‡§™‡§Ø‡§æ ‡§á‡§∏ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§ï‡•á ‡§π‡§Æ‡•á‡§Ç ‡§≠‡•á‡§ú‡•á‡§Ç‡•§</p>
            <pre id="error-details"></pre>
            <div class="modal-buttons">
                <button id="copy-error-btn" class="btn">‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç</button>
                <button id="close-error-btn" class="btn cancel-btn">‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
        </div>
    </div>
    
    <script>
        // IndexedDB ‡§ï‡•ã ‡§Æ‡•à‡§®‡•á‡§ú ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è Promise-based Wrapper
        const DB_NAME = 'KhataBookDB';
        const DB_VERSION = 3; // ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£ ‡§ï‡•ã 3 ‡§™‡§∞ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        const CUSTOMERS_STORE = 'customers';
        const DAILY_BOOK_STORE = 'dailyBook';
        const SUMMARY_STORE = 'customerSummary';
        const SETTINGS_STORE = 'settings'; // ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§Ø‡§æ ‡§∏‡•ç‡§ü‡•ã‡§∞
        let db;
        
        // ‡§è‡§ï Promise-‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ú‡•ã IndexedDB ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§ï‡•ã ‡§ñ‡•ã‡§≤‡§§‡§æ ‡§π‡•à ‡§Ø‡§æ ‡§¨‡§®‡§æ‡§§‡§æ ‡§π‡•à‡•§
        async function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    // 'customers' ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§¨‡§®‡§æ‡§è‡§Å
                    if (!db.objectStoreNames.contains(CUSTOMERS_STORE)) {
                        db.createObjectStore(CUSTOMERS_STORE, { keyPath: 'CustomerID', autoIncrement: true });
                    }
                    // 'dailyBook' ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§¨‡§®‡§æ‡§è‡§Å ‡§î‡§∞ 'CustomerID' ‡§™‡§∞ ‡§è‡§ï ‡§á‡§Ç‡§°‡•á‡§ï‡•ç‡§∏ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                    if (!db.objectStoreNames.contains(DAILY_BOOK_STORE)) {
                        const dailyBookStore = db.createObjectStore(DAILY_BOOK_STORE, { keyPath: 'EntryID', autoIncrement: true });
                        dailyBookStore.createIndex('CustomerID', 'CustomerID', { unique: false });
                    }
                    // 'customerSummary' ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§¨‡§®‡§æ‡§è‡§Å
                    if (!db.objectStoreNames.contains(SUMMARY_STORE)) {
                        db.createObjectStore(SUMMARY_STORE, { keyPath: 'CustomerID' });
                    }
                    // 'settings' ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§¨‡§®‡§æ‡§è‡§Å
                    if (!db.objectStoreNames.contains(SETTINGS_STORE)) {
                        db.createObjectStore(SETTINGS_STORE, { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = (event) => {
                    reject('Database error: ' + event.target.errorCode);
                };
            });
        }
        
        // ‡§è‡§ï ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§Æ‡•á‡§Ç ‡§°‡•á‡§ü‡§æ ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
        async function addData(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        // ‡§è‡§ï ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§∏‡•á ‡§∏‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
        async function getAllData(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        // ‡§è‡§ï ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§Æ‡•á‡§Ç ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
        async function updateData(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        // ‡§è‡§ï ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
        async function deleteData(storeName, key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(key);
                
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        // ‡§ï‡§ø‡§∏‡•Ä ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
        async function getData(storeName, key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        // ‡§ï‡§ø‡§∏‡•Ä ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§á‡§Ç‡§°‡•á‡§ï‡•ç‡§∏ ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
        async function getDataByIndex(storeName, indexName, key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const index = store.index(indexName);
                const request = index.getAll(key);

                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        // ‡§∏‡§≠‡•Ä ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§∏‡•á ‡§∏‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
        async function clearAllData() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([CUSTOMERS_STORE, DAILY_BOOK_STORE, SUMMARY_STORE, SETTINGS_STORE], 'readwrite');
                const customerStore = transaction.objectStore(CUSTOMERS_STORE);
                const dailyBookStore = transaction.objectStore(DAILY_BOOK_STORE);
                const summaryStore = transaction.objectStore(SUMMARY_STORE);
                const settingsStore = transaction.objectStore(SETTINGS_STORE);
                
                customerStore.clear();
                dailyBookStore.clear();
                summaryStore.clear();
                settingsStore.clear();
                
                transaction.oncomplete = () => resolve();
                transaction.onerror = (event) => reject(event.target.error);
            });
        }
        
        // UI ‡§è‡§≤‡§ø‡§Æ‡•á‡§Ç‡§ü‡•ç‡§∏ ‡§ï‡§æ ‡§ö‡§Ø‡§®
        const screens = document.querySelectorAll('.screen');
        const appContainer = document.getElementById('app-container');
        const customerCardList = document.getElementById('customer-card-list');
        const noCustomersMessage = document.getElementById('no-customers');
        const messageBox = document.getElementById('message-box');
        const fileInput = document.getElementById('file-input');
        const customerSearchInput = document.getElementById('customer-search');
        
        const summaryDueAmount = document.getElementById('summary-due-amount');
        const summaryPaidAmount = document.getElementById('summary-paid-amount');
        const fromDateInput = document.getElementById('from-date');
        const toDateInput = document.getElementById('to-date');
        const shareReportBtn = document.getElementById('shareReportBtn');
        const fullscreenBtns = document.querySelectorAll('[id^="fullscreen-btn"]');

        const errorModal = document.getElementById('error-modal');
        const errorDetails = document.getElementById('error-details');
        
        let allCustomers = [];
        let currentCustomerId = null;
        let deleteModalData = null;
        let importModalData = null;
        
        const THEME_KEY = 'app_theme';
        const MONTHS = ['‡§ú‡§®‡§µ‡§∞‡•Ä', '‡§´‡§∞‡§µ‡§∞‡•Ä', '‡§Æ‡§æ‡§∞‡•ç‡§ö', '‡§Ö‡§™‡•ç‡§∞‡•à‡§≤', '‡§Æ‡§à', '‡§ú‡•Ç‡§®', '‡§ú‡•Å‡§≤‡§æ‡§à', '‡§Ö‡§ó‡§∏‡•ç‡§§', '‡§∏‡§ø‡§§‡§Ç‡§¨‡§∞', '‡§Ö‡§ï‡•ç‡§ü‡•Ç‡§¨‡§∞', '‡§®‡§µ‡§Ç‡§¨‡§∞', '‡§¶‡§ø‡§∏‡§Ç‡§¨‡§∞'];

        // ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§®‡•á‡§µ‡§ø‡§ó‡•á‡§∂‡§® ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®
        function showScreen(id) {
            screens.forEach(screen => {
                screen.style.display = 'none';
            });
            document.getElementById(id).style.display = 'flex';
        }

        // ‡§´‡•ç‡§≤‡•ã‡§ü‡§ø‡§Ç‡§ó ‡§Æ‡•à‡§∏‡•á‡§ú ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§®‡§æ
        function showMessage(message, isSuccess = true) {
            messageBox.textContent = message;
            messageBox.className = 'show';
            if (!isSuccess) {
                messageBox.classList.add('error');
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
                messageBox.classList.remove('error');
            }, 3000);
        }

        // ‡§®‡§Ø‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§™‡•â‡§™‡§Ö‡§™ ‡§¶‡§ø‡§ñ‡§æ‡§®‡§æ
        function showErrorPopup(error) {
            const errorString = error instanceof Error ? error.stack : (error ? error.toString() : '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø');
            errorDetails.textContent = `Error: ${errorString}`;
            errorModal.style.display = 'flex';
        }

        // ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§™‡•â‡§™‡§Ö‡§™ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§®‡§æ
        function closeErrorPopup() {
            errorModal.style.display = 'none';
        }

        // ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•á ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡§æ
        async function updateCustomerSummary(customerId) {
            try {
                const transactions = await getDataByIndex(DAILY_BOOK_STORE, 'CustomerID', customerId);
                let totalDue = 0;
                let totalPaid = 0;

                transactions.forEach(entry => {
                    if (entry.Status === 'DUE') {
                        totalDue += entry.Amount;
                    } else {
                        totalPaid += entry.Amount;
                    }
                });

                const totalBalance = totalDue - totalPaid;

                const summaryData = {
                    CustomerID: customerId,
                    totalDue: totalDue,
                    totalPaid: totalPaid,
                    totalBalance: totalBalance
                };

                await updateData(SUMMARY_STORE, summaryData);
            } catch (error) {
                console.error('‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', error);
                showErrorPopup(error);
            }
        }
        
        // ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ‡§∞‡•ç‡§° ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡§®‡§æ
        async function renderCustomerList(filterText = '') {
            try {
                // `allCustomers` ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤ ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
                if (allCustomers.length === 0) {
                    allCustomers = await getAllData(CUSTOMERS_STORE);
                }

                const filteredCustomers = allCustomers.filter(customer =>
                    customer.Name.toLowerCase().includes(filterText.toLowerCase())
                );
                
                customerCardList.innerHTML = '';

                if (filteredCustomers.length === 0) {
                    noCustomersMessage.style.display = 'block';
                } else {
                    noCustomersMessage.style.display = 'none';
                    for (const customer of filteredCustomers) {
                        // ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§§‡§æ‡§≤‡§ø‡§ï‡§æ ‡§∏‡•á ‡§∏‡•Ä‡§ß‡•á ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç
                        const summary = await getData(SUMMARY_STORE, customer.CustomerID);
                        const balance = summary ? summary.totalBalance : 0;
                        
                        const wrapper = document.createElement('div');
                        wrapper.className = 'customer-card-wrapper';
                        
                        const cardInfo = document.createElement('div');
                        cardInfo.className = 'customer-card-info';
                        cardInfo.dataset.id = customer.CustomerID;
                        cardInfo.onclick = () => showCustomerHistory(customer.CustomerID);
                        
                        cardInfo.innerHTML = `
                            <div class="customer-name">${customer.Name}</div>
                            <div class="customer-mobile">${customer.MobileNo || '-'}</div>
                            <div class="customer-balance balance ${balance < 0 ? 'paid' : 'due'}">
                                ‚Çπ${Math.abs(balance).toFixed(2)}
                            </div>
                        `;
                        wrapper.appendChild(cardInfo);

                        // ‡§è‡§ï‡•ç‡§∂‡§® ‡§Æ‡•á‡§®‡•Ç ‡§¨‡§ü‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                        const actionCell = document.createElement('div');
                        actionCell.className = 'action-cell';
                        const actionBtn = document.createElement('button');
                        actionBtn.className = 'action-menu-btn';
                        actionBtn.textContent = '‚ãÆ';
                        actionBtn.onclick = (event) => toggleActionMenu(event, 'customers', customer.CustomerID);
                        actionCell.appendChild(actionBtn);
                        wrapper.appendChild(actionCell);

                        customerCardList.appendChild(wrapper);
                    }
                }
            } catch (error) {
                console.error('‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡•Ç‡§ö‡•Ä ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', error);
                showErrorPopup(error);
            }
        }

        // ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§¶‡§ø‡§ñ‡§æ‡§®‡§æ
        async function showCustomerHistory(customerId, startDate = null, endDate = null) {
            try {
                const customer = allCustomers.find(c => c.CustomerID === customerId);
                const allTransactions = await getDataByIndex(DAILY_BOOK_STORE, 'CustomerID', customerId);

                if (!customer) {
                    showMessage('‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§', false);
                    return;
                }
                
                currentCustomerId = customerId;
                document.getElementById('history-customer-name').textContent = customer.Name;
                
                // ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§§‡§æ‡§∞‡•Ä‡§ñ‡•á‡§Ç ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§Ö‡§ó‡§∞ ‡§µ‡•á ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ó‡§à ‡§π‡•à‡§Ç
                if (!startDate || !endDate) {
                    const today = new Date();
                    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    fromDateInput.valueAsDate = firstDayOfMonth;
                    toDateInput.valueAsDate = lastDayOfMonth;
                    startDate = firstDayOfMonth.toISOString().split('T')[0];
                    endDate = lastDayOfMonth.toISOString().split('T')[0];
                } else {
                    fromDateInput.value = startDate;
                    toDateInput.value = endDate;
                }
                
                const filteredTransactions = allTransactions.filter(entry => {
                    const entryDate = new Date(entry.EntryDate);
                    return entryDate >= new Date(startDate) && entryDate <= new Date(endDate);
                });

                let dueInMonth = 0;
                let paidInMonth = 0;
                
                filteredTransactions.forEach(entry => {
                    if (entry.Status === 'DUE') {
                        dueInMonth += entry.Amount;
                    } else {
                        paidInMonth += entry.Amount;
                    }
                });

                summaryDueAmount.textContent = `‚Çπ${dueInMonth.toFixed(2)}`;
                summaryPaidAmount.textContent = `‚Çπ${paidInMonth.toFixed(2)}`;

                const sortedTransactions = filteredTransactions.sort((a, b) => new Date(b.EntryDate) - new Date(a.EntryDate));

                const tableBody = document.getElementById('history-table-body');
                tableBody.innerHTML = '';

                if (sortedTransactions.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 2rem; color: #999;">‡§á‡§∏ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§∏‡•Ä‡§Æ‡§æ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</td></tr>`;
                }

                sortedTransactions.forEach(entry => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${entry.EntryDate}</td>
                        <td>${entry.JobDetail || '-'}</td>
                        <td>‚Çπ${entry.Amount.toFixed(2)}</td>
                        <td class="status-cell ${entry.Status}">${entry.Status === 'DUE' ? '‡§¶‡•á‡§Ø' : '‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ'}</td>
                        <td class="action-cell">
                            <button class="action-menu-btn" data-entry-id="${entry.EntryID}">‚ãÆ</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                document.querySelectorAll('.action-menu-btn').forEach(btn => {
                    btn.onclick = (event) => toggleActionMenu(event, 'dailyBook', parseInt(btn.dataset.entryId), customerId);
                });
                
                showScreen('history-screen');
            } catch (error) {
                console.error('‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', error);
                showErrorPopup(error);
            }
        }
        
        // ‡§ï‡•Å‡§≤ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§¶‡§ø‡§ñ‡§æ‡§®‡§æ
        async function showOverallSummary() {
            try {
                const summaries = await getAllData(SUMMARY_STORE);
                const customers = await getAllData(CUSTOMERS_STORE);
                const summaryList = document.getElementById('overall-summary-list');
                const overallDueAmount = document.getElementById('overall-due-amount');
                summaryList.innerHTML = '';
                
                let totalDue = 0;
                
                for (const summary of summaries) {
                    const customer = customers.find(c => c.CustomerID === summary.CustomerID);
                    if (customer && summary.totalBalance > 0) {
                        totalDue += summary.totalBalance;
                        const card = document.createElement('div');
                        card.className = 'overall-summary-card';
                        card.innerHTML = `
                            <span>${customer.Name}</span>
                            <span class="balance due">‚Çπ${summary.totalBalance.toFixed(2)}</span>
                        `;
                        summaryList.appendChild(card);
                    }
                }
                
                overallDueAmount.textContent = `‚Çπ${totalDue.toFixed(2)}`;
                showScreen('overall-summary-screen');
            } catch (error) {
                console.error('‡§ï‡•Å‡§≤ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', error);
                showErrorPopup(error);
            }
        }

        // ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§´‡§º‡•â‡§∞‡•ç‡§Æ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§π‡•à‡§Ç‡§°‡§≤‡§∞
        document.getElementById('customer-form').onsubmit = async (event) => {
            event.preventDefault();
            const customerId = document.getElementById('customer-id').value;
            const customerName = document.getElementById('customer-name').value;
            const customerMobile = document.getElementById('customer-mobile').value;
            const customerType = document.getElementById('customer-type').value;
            
            const customerData = {
                Name: customerName,
                MobileNo: customerMobile,
                Type: customerType
            };
            
            try {
                if (customerId) {
                    // ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                    customerData.CustomerID = parseInt(customerId);
                    await updateData(CUSTOMERS_STORE, customerData);
                    showMessage('‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§');
                } else {
                    // ‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                    const newCustomerId = await addData(CUSTOMERS_STORE, customerData);
                    // ‡§®‡§è ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠‡§ø‡§ï ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§¨‡§®‡§æ‡§è‡§Å
                    await addData(SUMMARY_STORE, { CustomerID: newCustomerId, totalDue: 0, totalPaid: 0, totalBalance: 0 });
                    showMessage('‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ‡•§');
                }
                document.getElementById('customer-form').reset();
                showScreen('home-screen');
                allCustomers = await getAllData(CUSTOMERS_STORE); // ‡§Ö‡§™‡§°‡•á‡§ü‡•á‡§° ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç
                renderCustomerList();
            } catch (error) {
                console.error('‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡§π‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', error);
                showErrorPopup(error);
            }
        };

        // ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§´‡§º‡•â‡§∞‡•ç‡§Æ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§π‡•à‡§Ç‡§°‡§≤‡§∞
        document.getElementById('daily-entry-form').onsubmit = async (event) => {
            event.preventDefault();
            const entryId = document.getElementById('entry-id').value;
            const customerId = parseInt(document.getElementById('entry-customer-id').value);
            const entryDate = document.getElementById('entry-date').value;
            const entryDetail = document.getElementById('entry-detail').value;
            const entryAmount = parseFloat(document.getElementById('entry-amount').value);
            const entryStatus = document.getElementById('entry-status').value;

            const entryData = {
                CustomerID: customerId,
                EntryDate: entryDate,
                JobDetail: entryDetail,
                Amount: entryAmount,
                Status: entryStatus
            };

            try {
                if (entryId) {
                    entryData.EntryID = parseInt(entryId);
                    await updateData(DAILY_BOOK_STORE, entryData);
                    showMessage('‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§');
                } else {
                    await addData(DAILY_BOOK_STORE, entryData);
                    showMessage('‡§®‡§Ø‡§æ ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ‡•§');
                }
                
                await updateCustomerSummary(customerId); // ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                document.getElementById('daily-entry-form').reset();
                showCustomerHistory(customerId);
            } catch (error) {
                console.error('‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§∏‡§π‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', error);
                showErrorPopup(error);
            }
        };
        
        // ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§´‡§º‡•â‡§∞‡•ç‡§Æ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§π‡•à‡§Ç‡§°‡§≤‡§∞
        document.getElementById('settings-form').onsubmit = async (event) => {
            event.preventDefault();
            const theme = document.querySelector('input[name="theme"]:checked').value;
            const upiId = document.getElementById('upi-id').value;
            const userName = document.getElementById('user-name').value;
            
            const settingsData = {
                id: THEME_KEY,
                theme: theme,
                upi_id: upiId,
                user_name: userName
            };
            
            try {
                await updateData(SETTINGS_STORE, settingsData);
                applyTheme(theme);
                showMessage('‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡§π‡•á‡§ú‡•Ä ‡§ó‡§à‡•§');
                showScreen('home-screen');
            } catch (error) {
                console.error('‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§∏‡§π‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', error);
                showErrorPopup(error);
            }
        };

        // ‡§•‡•Ä‡§Æ ‡§ï‡•ã ‡§≤‡§æ‡§ó‡•Ç ‡§ï‡§∞‡§®‡§æ
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }
        }

        // ‡§´‡•Å‡§≤‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ï‡•ã ‡§ö‡§æ‡§≤‡•Ç/‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§®‡§æ
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                appContainer.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                    showErrorPopup(err);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // ‡§´‡•Å‡§≤‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§á‡§µ‡•á‡§Ç‡§ü ‡§™‡§∞ ‡§¨‡§ü‡§® ‡§ï‡§æ ‡§Ü‡§á‡§ï‡§® ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡§æ
        document.addEventListener('fullscreenchange', (event) => {
            const isFullscreen = document.fullscreenElement;
            fullscreenBtns.forEach(btn => {
                btn.textContent = isFullscreen ? '‚õ∂' : '‚õ∂'; // ‡§è‡§ï ‡§π‡•Ä ‡§Ü‡§á‡§ï‡§® ‡§∞‡§ñ‡§§‡•á ‡§π‡•à‡§Ç
            });
        });

        // ‡§è‡§ï‡•ç‡§∂‡§® ‡§Æ‡•á‡§®‡•Ç ‡§ï‡§æ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç ‡§î‡§∞ ‡§â‡§∏‡•á ‡§´‡•ç‡§≤‡§ø‡§™ ‡§ï‡§∞‡•á‡§Ç
        function toggleActionMenu(event, type, key, customerId = null) {
            const existingMenu = document.querySelector('.action-menu');
            if (existingMenu) {
                existingMenu.remove();
            }

            // ‡§Ö‡§ó‡§∞ ‡§Æ‡•á‡§®‡•Ç ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§ñ‡•Å‡§≤‡§æ ‡§•‡§æ ‡§î‡§∞ ‡§â‡§∏‡•Ä ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ, ‡§§‡•ã ‡§¨‡§∏ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
            if (existingMenu && existingMenu.dataset.key === key.toString()) {
                return;
            }

            const menu = document.createElement('div');
            menu.className = 'action-menu';
            menu.dataset.key = key;

            const editBtn = document.createElement('button');
            editBtn.textContent = '‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç';
            editBtn.onclick = () => {
                if (type === 'customers') {
                    editCustomer(parseInt(key));
                } else {
                    editTransaction(parseInt(key));
                }
                menu.remove();
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '‡§π‡§ü‡§æ‡§è‡§Å';
            deleteBtn.onclick = () => {
                showDeleteModal(type, parseInt(key), customerId);
                menu.remove();
            };

            menu.appendChild(editBtn);
            menu.appendChild(deleteBtn);
            
            const parentCell = event.target.closest('.action-cell');
            parentCell.appendChild(menu);

            // ‡§Æ‡•á‡§®‡•Ç ‡§ï‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§ó‡§∞ ‡§ú‡§∞‡•Ç‡§∞‡§§ ‡§π‡•ã ‡§§‡•ã ‡§â‡§∏‡•á ‡§´‡•ç‡§≤‡§ø‡§™ ‡§ï‡§∞‡•á‡§Ç
            const rect = menu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                menu.classList.add('left');
            }
        }

        // ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•ã ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ
        async function editCustomer(customerId) {
            try {
                const customers = await getAllData(CUSTOMERS_STORE);
                const customer = customers.find(c => c.CustomerID === customerId);
                if (customer) {
                    document.getElementById('customer-id').value = customer.CustomerID;
                    document.getElementById('customer-name').value = customer.Name;
                    document.getElementById('customer-mobile').value = customer.MobileNo;
                    document.getElementById('customer-type').value = customer.Type;
                    document.getElementById('add-customer-title').textContent = '‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç';
                    showScreen('add-customer-screen');
                } else {
                    showMessage('‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§', false);
                }
            } catch (error) {
                console.error('‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', error);
                showErrorPopup(error);
            }
        }
        
        // ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§ï‡•ã ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ
        async function editTransaction(entryId) {
            try {
                const entry = await getData(DAILY_BOOK_STORE, entryId);
                if (entry) {
                    document.getElementById('entry-id').value = entry.EntryID;
                    document.getElementById('entry-customer-id').value = entry.CustomerID;
                    document.getElementById('entry-date').value = entry.EntryDate;
                    document.getElementById('entry-detail').value = entry.JobDetail;
                    document.getElementById('entry-amount').value = entry.Amount;
                    document.getElementById('entry-status').value = entry.Status;
                    showScreen('daily-entry-screen');
                } else {
                    showMessage('‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§', false);
                }
            } catch (error) {
                console.error('‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', error);
                showErrorPopup(error);
            }
        }

        // ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§®‡•ç‡§´‡§∞‡•ç‡§Æ‡•á‡§∂‡§® ‡§Æ‡•ã‡§°‡§≤ ‡§¶‡§ø‡§ñ‡§æ‡§®‡§æ
        function showDeleteModal(type, key, customerId = null) {
            deleteModalData = { type, key, customerId };
            document.getElementById('delete-modal').style.display = 'flex';
        }
        
        // ‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ
        async function handleDeleteConfirm() {
            if (!deleteModalData) return;
            const { type, key, customerId } = deleteModalData;
            try {
                if (type === 'customers') {
                    // ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§î‡§∞ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡•ã ‡§π‡§ü‡§æ‡§è‡§Å
                    const customerTransactions = await getDataByIndex(DAILY_BOOK_STORE, 'CustomerID', key);
                    
                    for (const transaction of customerTransactions) {
                        await deleteData(DAILY_BOOK_STORE, transaction.EntryID);
                    }
                    
                    await deleteData(CUSTOMERS_STORE, key);
                    await deleteData(SUMMARY_STORE, key); // ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§π‡§ü‡§æ‡§è‡§Å
                    
                    showMessage('‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§î‡§∞ ‡§â‡§∏‡§∏‡•á ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§∏‡§≠‡•Ä ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§è ‡§ó‡§è ‡§π‡•à‡§Ç‡•§');
                    
                    showScreen('home-screen');
                    allCustomers = await getAllData(CUSTOMERS_STORE);
                    renderCustomerList(customerSearchInput.value);
                    
                } else {
                    await deleteData(DAILY_BOOK_STORE, key);
                    await updateCustomerSummary(customerId); // ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                    showMessage('‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§');
                    showCustomerHistory(customerId);
                }
            } catch (error) {
                console.error('‡§°‡•á‡§ü‡§æ ‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', error);
                showErrorPopup(error);
            }
            document.getElementById('delete-modal').style.display = 'none';
        }
        
        // ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§®‡•ç‡§´‡§∞‡•ç‡§Æ‡•á‡§∂‡§® ‡§Æ‡•ã‡§°‡§≤ ‡§¶‡§ø‡§ñ‡§æ‡§®‡§æ
        function showImportConfirmModal(data) {
            importModalData = data;
            document.getElementById('import-confirm-modal').style.display = 'flex';
        }
        
        // ‡§°‡•á‡§ü‡§æ ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡§®‡§æ
        async function handleImportConfirm() {
            document.getElementById('import-confirm-modal').style.display = 'none';
            if (!importModalData) return;

            try {
                // 1. ‡§∏‡§≠‡•Ä ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§π‡§ü‡§æ‡§è‡§Å
                await clearAllData();
                
                // 2. ‡§®‡§è ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§¨‡§ø‡§®‡§æ IDs ‡§ï‡•á ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                const customerIdMap = new Map();
                for (const customer of importModalData.customers) {
                    const oldCustomerId = customer.CustomerID;
                    delete customer.CustomerID; // ID ‡§π‡§ü‡§æ‡§è‡§Å ‡§§‡§æ‡§ï‡§ø ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡•á
                    const newId = await addData(CUSTOMERS_STORE, customer);
                    customerIdMap.set(oldCustomerId, newId);
                }
                
                for (const entry of importModalData.dailyBook) {
                    const oldCustomerId = entry.CustomerID;
                    const newCustomerId = customerIdMap.get(oldCustomerId);
                    
                    if (newCustomerId) {
                        entry.CustomerID = newCustomerId; // ‡§®‡§à CustomerID ‡§Ö‡§∏‡§æ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç
                        delete entry.EntryID; // ID ‡§π‡§ü‡§æ‡§è‡§Å ‡§§‡§æ‡§ï‡§ø ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡•á
                        await addData(DAILY_BOOK_STORE, entry);
                    }
                }
                
                // 3. ‡§∏‡§≠‡•Ä ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§¨‡§®‡§æ‡§è‡§Å
                const allCustomersAfterImport = await getAllData(CUSTOMERS_STORE);
                for(const customer of allCustomersAfterImport){
                    await updateCustomerSummary(customer.CustomerID);
                }
                
                // 4. ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§ï‡•ã ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç
                // ‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç ‡§ï‡§ø ‡§ï‡•ç‡§Ø‡§æ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§°‡•á‡§ü‡§æ ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à
                const importedSettings = importModalData.settings;
                const settingsToSave = importedSettings && importedSettings.id ? importedSettings : { id: THEME_KEY, theme: 'light' };
                await updateData(SETTINGS_STORE, settingsToSave);
                applyTheme(settingsToSave.theme);

                showMessage('‡§°‡•á‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§');
                showScreen('home-screen');
                allCustomers = await getAllData(CUSTOMERS_STORE);
                renderCustomerList();
            } catch (error) {
                console.error('‡§°‡•á‡§ü‡§æ ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', error);
                showErrorPopup(error);
            }
        }

        // JSON ‡§µ‡•ç‡§Ø‡•Ç‡§Ö‡§∞ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§¶‡§ø‡§ñ‡§æ‡§®‡§æ
        async function showJsonViewer() {
            try {
                const customers = await getAllData(CUSTOMERS_STORE);
                const dailyBook = await getAllData(DAILY_BOOK_STORE);
                const summary = await getAllData(SUMMARY_STORE);
                const settings = await getData(SETTINGS_STORE, THEME_KEY);
                
                const dbData = {
                    customers: customers,
                    dailyBook: dailyBook,
                    customerSummary: summary,
                    settings: settings || {}
                };
                
                const jsonOutputElement = document.getElementById('json-output');
                jsonOutputElement.textContent = JSON.stringify(dbData, null, 2);
                
                showScreen('json-viewer-screen');
            } catch (error) {
                console.error('JSON ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', error);
                showErrorPopup(error);
            }
        }
        
        // ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®
        async function shareReport() {
            try {
                // ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç
                const settings = await getData(SETTINGS_STORE, THEME_KEY);
                const userName = settings?.user_name || '‡§Ü‡§™‡§ï‡•á ‡§®‡§æ‡§Æ';
                const upiId = settings?.upi_id;

                if (!upiId) {
                    showMessage('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§Ö‡§™‡§®‡•Ä UPI ID ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§', false);
                    return;
                }

                // ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§î‡§∞ ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç
                const customer = allCustomers.find(c => c.CustomerID === currentCustomerId);
                const allTransactions = await getDataByIndex(DAILY_BOOK_STORE, 'CustomerID', currentCustomerId);

                const fromDate = fromDateInput.value;
                const toDate = toDateInput.value;
                const fromDateObj = new Date(fromDate);
                const toDateObj = new Date(toDate);

                // ‡§™‡§ø‡§õ‡§≤‡•á ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§ï‡•Ä ‡§ó‡§£‡§®‡§æ
                const previousTransactions = allTransactions.filter(t => new Date(t.EntryDate) < fromDateObj);
                let previousDue = 0;
                let previousPaid = 0;
                previousTransactions.forEach(t => {
                    if (t.Status === 'DUE') previousDue += t.Amount;
                    else previousPaid += t.Amount;
                });
                const previousBalance = previousDue - previousPaid;

                // ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§î‡§∞ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§ï‡•Ä ‡§ó‡§£‡§®‡§æ
                const currentTransactions = allTransactions.filter(t => {
                    const entryDate = new Date(t.EntryDate);
                    return entryDate >= fromDateObj && entryDate <= toDateObj;
                });
                
                let currentDue = 0;
                let currentPaid = 0;
                const transactionHistoryList = [];
                currentTransactions.forEach(t => {
                    if (t.Status === 'DUE') {
                        currentDue += t.Amount;
                        transactionHistoryList.push(`‚û°Ô∏è ${t.EntryDate}: ${t.JobDetail || '‡§ï‡•ã‡§à ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§®‡§π‡•Ä‡§Ç'} - ‚Çπ${t.Amount.toFixed(2)} (‡§¨‡§ï‡§æ‡§Ø‡§æ)`);
                    } else {
                        currentPaid += t.Amount;
                        transactionHistoryList.push(`‚¨ÖÔ∏è ${t.EntryDate}: ${t.JobDetail || '‡§ï‡•ã‡§à ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§®‡§π‡•Ä‡§Ç'} - ‚Çπ${t.Amount.toFixed(2)} (‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§ø‡§Ø‡§æ)`);
                    }
                });
                
                const totalBalance = previousBalance + currentDue - currentPaid;

                // ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Æ‡•à‡§∏‡•á‡§ú ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç
                const transactionListText = transactionHistoryList.length > 0 ? transactionHistoryList.join('\n') : '‡§ï‡•ã‡§à ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§®‡§π‡•Ä‡§Ç‡•§';
                const reportMessage = `
üôè‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${customer.Name},
üìÑ ‡§Ø‡§π ‡§Ü‡§™‡§ï‡•á ‡§ñ‡§æ‡§§‡•á ‡§ï‡§æ ‡§®‡§µ‡•Ä‡§®‡§§‡§Æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§π‡•à‡•§
---------------------------
üë§ ${userName}
üí∞ ‡§™‡§ø‡§õ‡§≤‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ (‡§ö‡§Ø‡§®‡§ø‡§§ ‡§§‡§ø‡§•‡§ø ‡§∏‡•á ‡§™‡§π‡§≤‡•á):
‚Çπ${previousBalance.toFixed(2)}
---------------------------
üìÑ ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä (${fromDateObj.toLocaleDateString('hi-IN')} - ${toDateObj.toLocaleDateString('hi-IN')})
${transactionListText}
---------------------------
üìä ‡§∏‡§Æ‡§∞‡•Ä
‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø: ‚Çπ${currentDue.toFixed(2)}
‡§ï‡•Å‡§≤ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§ø‡§Ø‡§æ: ‚Çπ${currentPaid.toFixed(2)}

üí∞ ‡§ï‡•Å‡§≤ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø = ‡§™‡§ø‡§õ‡§≤‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ + ‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø - ‡§ï‡•Å‡§≤ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®
‚Çπ${totalBalance.toFixed(2)} = ${previousBalance.toFixed(2)} + ${currentDue.toFixed(2)} - ${currentPaid.toFixed(2)}
üí∞ ‡§ï‡•Å‡§≤ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø = ‚Çπ${totalBalance.toFixed(2)}

${totalBalance > 0 ? `üîó UPI ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è: upi://pay?pa=${upiId}&pn=${encodeURIComponent(userName)}&am=${totalBalance.toFixed(2)}&cu=INR` : ''}
`;
                
                // WhatsApp ‡§™‡§∞ ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç
                const whatsappUrl = `whatsapp://send?text=${encodeURIComponent(reportMessage)}`;
                window.open(whatsappUrl);

            } catch (error) {
                console.error('‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', error);
                showErrorPopup(error);
            }
        }
        
        // ‡§∏‡§≠‡•Ä ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡§®‡§∞
        window.onload = async () => {
            try {
                await openDatabase();
                const settings = await getData(SETTINGS_STORE, THEME_KEY);
                if (settings) {
                    applyTheme(settings.theme);
                }
                allCustomers = await getAllData(CUSTOMERS_STORE);
                await renderCustomerList();
                showScreen('home-screen');
            } catch (error) {
                console.error("‡§ê‡§™ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:", error);
                showErrorPopup(error);
            }
            
            // Fullscreen button listeners
            fullscreenBtns.forEach(btn => {
                btn.onclick = toggleFullscreen;
            });
            
            // Database menu toggle
            const databaseMenuBtn = document.getElementById('database-menu-btn');
            const databaseDropdown = document.getElementById('database-dropdown');
            databaseMenuBtn.onclick = (event) => {
                event.stopPropagation();
                databaseDropdown.classList.toggle('show');
            };
            document.addEventListener('click', () => {
                databaseDropdown.classList.remove('show');
            });
            
            // Home screen buttons
            document.getElementById('add-customer-btn').onclick = () => {
                document.getElementById('customer-form').reset();
                document.getElementById('customer-id').value = '';
                document.getElementById('add-customer-title').textContent = '‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç';
                showScreen('add-customer-screen');
            };
            document.getElementById('overallSummaryBtn').onclick = showOverallSummary;
            document.getElementById('show-json-btn').onclick = showJsonViewer;
            document.getElementById('settings-btn').onclick = async () => {
                const settings = await getData(SETTINGS_STORE, THEME_KEY);
                if (settings) {
                    document.querySelector(`input[name="theme"][value="${settings.theme}"]`).checked = true;
                    document.getElementById('upi-id').value = settings.upi_id || '';
                    document.getElementById('user-name').value = settings.user_name || '';
                }
                showScreen('settings-screen');
            };

            // Search bar
            customerSearchInput.addEventListener('input', (event) => {
                renderCustomerList(event.target.value);
            });

            // Back buttons
            document.getElementById('add-customer-back-btn').onclick = () => { showScreen('home-screen'); renderCustomerList(customerSearchInput.value); };
            document.getElementById('daily-entry-back-btn').onclick = () => showCustomerHistory(currentCustomerId);
            document.getElementById('history-back-btn').onclick = () => { showScreen('home-screen'); renderCustomerList(customerSearchInput.value); };
            document.getElementById('overall-summary-back-btn').onclick = () => { showScreen('home-screen'); renderCustomerList(customerSearchInput.value); };
            document.getElementById('json-viewer-back-btn').onclick = () => { showScreen('home-screen'); renderCustomerList(customerSearchInput.value); };
            document.getElementById('settings-back-btn').onclick = () => { showScreen('home-screen'); renderCustomerList(customerSearchInput.value); };
            
            // History screen
            document.getElementById('addTransactionTopBtn').onclick = () => {
                document.getElementById('daily-entry-form').reset();
                document.getElementById('entry-id').value = '';
                document.getElementById('entry-customer-id').value = currentCustomerId;
                document.getElementById('entry-date').valueAsDate = new Date();
                showScreen('daily-entry-screen');
            };
            
            // Date filter OK button click handler
            document.getElementById('filter-ok-btn').onclick = () => {
                const fromDate = fromDateInput.value;
                const toDate = toDateInput.value;
                
                // ‡§§‡§æ‡§∞‡•Ä‡§ñ‡•ã‡§Ç ‡§ï‡•ã ‡§µ‡•à‡§≤‡§ø‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                if (new Date(fromDate) > new Date(toDate)) {
                    showMessage('From ‡§§‡§æ‡§∞‡•Ä‡§ñ To ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è‡•§', false);
                    return;
                }
                showCustomerHistory(currentCustomerId, fromDate, toDate);
            };

            // Share button click handler
            shareReportBtn.onclick = shareReport;
            
            // Delete modal buttons
            document.getElementById('delete-confirm-btn').onclick = handleDeleteConfirm;
            document.getElementById('delete-cancel-btn').onclick = () => document.getElementById('delete-modal').style.display = 'none';

            // Import/Export buttons
            document.getElementById('import-btn').onclick = () => fileInput.click();
            document.getElementById('export-btn').onclick = async () => {
                try {
                    const customers = await getAllData(CUSTOMERS_STORE);
                    const dailyBook = await getAllData(DAILY_BOOK_STORE);
                    const summary = await getAllData(SUMMARY_STORE);
                    const settings = await getData(SETTINGS_STORE, THEME_KEY);
                    
                    const data = { customers, dailyBook, customerSummary: summary, settings: settings || {} };
                    const jsonString = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    
                    const a = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    a.href = url;
                    a.download = `khatabook_${timestamp}.json`;
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showMessage('‡§°‡•á‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§');
                } catch (error) {
                    console.error('‡§°‡•á‡§ü‡§æ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', error);
                    showErrorPopup(error);
                }
            };

            // File input change listener for import
            fileInput.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!importedData.customers || !Array.isArray(importedData.customers) || !importedData.dailyBook || !Array.isArray(importedData.dailyBook)) {
                            showMessage('‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§´‡§º‡§æ‡§á‡§≤ ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™‡•§', false);
                            return;
                        }
                        showImportConfirmModal(importedData);
                    } catch (error) {
                        showErrorPopup(error);
                    }
                };
                reader.readAsText(file);
            };

            // Import modal buttons
            document.getElementById('import-confirm-btn').onclick = handleImportConfirm;
            document.getElementById('import-cancel-btn').onclick = () => document.getElementById('import-confirm-modal').style.display = 'none';
            
            // Error modal buttons
            document.getElementById('close-error-btn').onclick = closeErrorPopup;
            document.getElementById('copy-error-btn').onclick = () => {
                try {
                    const textToCopy = errorDetails.textContent;
                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = textToCopy;
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextarea);
                    showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§', true);
                    closeErrorPopup();
                } catch (err) {
                    showMessage('‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§', false);
                    console.error("‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:", err);
                }
            };
        };
    </script>
</body>
</html>
